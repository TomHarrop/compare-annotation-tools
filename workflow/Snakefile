#!/usr/bin/env python3

from datetime import date
from functools import cache
from pathlib import Path
from snakemake.logging import logger


# tool config (different to run config)
configfile: "config/tools.yaml"


# Order is important!
include: "rules/01_globals.smk"
include: "rules/02_common_rules.smk"
include: "rules/03_functions.smk"
include: "rules/10_funannotate_setup.smk"
include: "rules/11_download_busco_dataset.smk"
include: "rules/20_collect_rnaseq_data.smk"
include: "rules/30_braker3.smk"
include: "rules/31_funannotate.smk"
include: "rules/32_helixer.smk"
include: "rules/33_tiberius.smk"
include: "rules/40_qc.smk"
include: "rules/50_collate_stats.smk"


rule collect_annotation:
    localrule: True
    input:
        result_file=Path("results", "run", "{genome}", "{tool}", "{result_file}"),
    output:
        result_file=Path("results", "{genome}", "{tool}", "annotation", "{result_file}"),
    shell:
        "cp {input.result_file} {output.result_file}"


rule target:
    default_target: True
    input:
        expand(get_results(), genome=all_genomes),


# Run stats collection no matter what, because some tools will fail.
onsuccess:
    collate_stats()


onerror:
    collate_stats()
